## Section 21 정리

### LAN 설계

이번 강의에서는 로컬 영역 네트워크(LAN)의 설계에 대해 학습합니다. 

1. 로컬 영역 네트워크(LAN) 범위
- **단일 건물** 또는 **로컬 캠퍼스 내 여러 건물**을 대상으로 하는 네트워크 설계에 집중.
- **광역 네트워크(WAN)**(예: 뉴욕, 휴스턴, 싱가포르에 걸친 네트워크)는 이후 섹션에서 다룸.

2. LAN 설계 고려 사항
- **확장성**과 **성능**, **보안**을 고려한 설계 필요.
- 네트워크 토폴로지를 **액세스층**, **분배층**, **코어층**으로 나누어 설계.

3. 계층별 설계 원칙
1. **액세스층**
   - 캠퍼스 본관과 별도 건물의 각 층에 여러 액세스 스위치 설치.
   - 종단 호스트(데스크톱, 서버, IP 전화 등)가 연결되는 계층.
   - 저비용으로 높은 포트 개수를 제공해 다수의 호스트 지원.
   - 포트 보안 등 클라이언트 액세스 보안 활성화.
   
2. **분배층**
   - 액세스층 스위치가 분배층 스위치로 업링크.
   - 액세스층 스위치들 간 연결은 없으며, 분배층 스위치로 집성됨.
   - 분배층 스위치는 다중 쌍으로 구성되어 단일 장애 지점을 방지.
   - **서비스 품질(QoS) 정책** 등 주요 소프트웨어 정책 활성화.

3. **코어층**
   - 분배층 스위치가 코어층 스위치로 업링크.
   - 모든 빌딩의 분배층 스위치를 연결해 속도와 복원성 중심으로 설계.
   - 소프트웨어 정책은 속도 저하를 방지하기 위해 최소화.

4. 소규모 네트워크 설계
- 소규모 캠퍼스의 경우, **분배층과 코어층을 통합**하여 설계.
- 단일 하드웨어 장치에서 분배 및 코어 역할을 수행.

요약
- **액세스층**: 종단 호스트 연결, 높은 포트 개수, 보안 정책 구현.
- **분배층**: 액세스층 집성, 다중성 확보, QoS 등 소프트웨어 정책 적용.
- **코어층**: 속도와 복원성 중점, 분배층 연결, 소프트웨어 정책 최소화.

### 스파인-리프 데이터 센터 네트워크 설계

1. 전통적인 캠퍼스 네트워크 설계
- **코어층, 분배층, 액세스층**으로 구성된 계층형 설계.
- **북쪽-남쪽(North-South)** 트래픽 흐름에 최적화된 방식.
  - 예: 데이터 센터 내에서 데이터가 코어층으로 올라갔다가 다시 내려가 클라이언트에게 전달되는 방식.
- 이 구조는 클라이언트가 데이터 센터와 주로 통신할 때 적합.

2. 현대적 데이터 센터의 동-서(East-West) 트래픽 증가
- **동쪽-서쪽(East-West)** 트래픽은 데이터 센터 내 서버들 간의 트래픽 흐름을 의미.
  - 예: 서버 간 통신(프론트엔드 서버와 백엔드 데이터베이스 간 데이터 전송).
- **가상화**와 **서버 클러스터링** 증가로 인해 동쪽-서쪽 트래픽 비중이 높아짐.
- 전통적 네트워크 설계는 동쪽-서쪽 트래픽이 많은 경우 성능 저하가 발생할 수 있음.

3. 스파인-리프 데이터 센터 설계
- **스파인(Spine)** 스위치와 **리프(Leaf)** 스위치로 구성된 설계.
- 리프 스위치들은 각 서버에 연결되며, 각 리프 스위치는 모든 스파인 스위치와 **그물망 형태의 연결**을 가짐.
- **확장성과 성능**을 극대화하기 위해 동쪽-서쪽 트래픽에 최적화.
  - 리프 스위치를 추가하는 방식으로 손쉽게 확장 가능.
  - 최대 두 개 홉(1 홉: 리프 → 스파인, 2 홉: 스파인 → 리프)으로 서버 간 통신 가능.
  
4. 스파인-리프 설계의 장점
- **확장성**: 네트워크 크기를 쉽게 확장할 수 있음.
- **성능**: 동쪽-서쪽 트래픽이 많을 때도 높은 성능 유지.
- 북쪽-남쪽 트래픽도 여전히 잘 작동하지만, 동쪽-서쪽 트래픽에 대한 추가 이점이 있음.

### VLAN 사용의 필요성과 이점

1. VLAN을 사용하는 이유
- VLAN은 **스위치**에서 **2계층** 기능으로 구현됩니다.
- VLAN이 필요한 이유를 이해하려면, VLAN이 해결해주는 문제점에 대해 먼저 알아야 합니다.

2. 라우터와 스위치 운용 방식 비교
- **라우터**는 **3계층** 장비로, 여러 IP 서브넷 간의 트래픽을 라우팅하고, **보안 규칙**을 통해 서브넷 간 트래픽을 제어할 수 있습니다.
  - 예: 엔지니어링 서브넷(10.10.10.0/24)과 회계 서브넷(10.10.20.0/24) 간의 트래픽을 제한.
- **스위치**는 **2계층** 장비로, 기본적으로 브로드캐스트 트래픽을 전송하여 모든 포트로 전파합니다. 이로 인해 **보안 문제**와 **성능 저하**가 발생할 수 있습니다.
  - 유니캐스트의 경우 효율적으로 처리함.
  - 스위치는 IP를 모르므로, 특정 서브넷에만 요청을 전송할 수 없음. 스위치에 연결된 모든 HOST에 브로드캐스트를 보내게 됨.

3. 스위치 기반 네트워크의 문제점
- **브로드캐스트 도메인**: 스위치는 기본적으로 모든 IP 서브넷에 브로드캐스트 트래픽을 전송합니다.
- 이로 인해 불필요한 트래픽이 전체 네트워크에 전파되며, 보안 위험과 성능 저하를 유발할 수 있습니다.
- 예를 들어, 영업 팀의 PC가 브로드캐스트 트래픽(예: ARP 트래픽)을 전송하면 엔지니어링 팀과 회계 팀 모두 이 트래픽을 수신하게 됩니다.

4. VLAN의 역할과 장점
- VLAN을 이용하면 스위치를 통해 네트워크를 **여러 개의 브로드캐스트 도메인**으로 분할할 수 있습니다.
- **IP 서브넷과 VLAN 간 일대일 관계**를 설정하여 네트워크 성능과 보안을 향상시킵니다.
- 메모: 물리적인 LAN보다 더 작은 규모의 LAN이 존재하는 것처럼 사용할 수 있음. (브로드캐스트 범위 제한 등, VLAN 단위를 IP 서브넷 단위로 설정 등)

5. VLAN을 적용한 네트워크 예시
- VLAN을 적용하여 스위치 내에 **엔지니어링 VLAN**과 **영업 팀 VLAN**을 구분할 수 있습니다.
- 동일 VLAN 내의 장치들만 트래픽을 주고받을 수 있도록 구성하여 브로드캐스트 트래픽이 필요한 곳으로만 전송되도록 합니다.
- 예를 들어, 영업 팀 PC가 브로드캐스트 트래픽을 전송할 경우, 영업 팀 VLAN에 속한 장치들로만 트래픽이 전달되어 성능과 보안이 강화됩니다.

6. VLAN을 통한 보안과 성능 향상
- **보안**: VLAN을 통해 트래픽이 특정 VLAN에 속한 장치로만 전달되므로, 네트워크 세그먼트 간 불필요한 트래픽이 줄어들고 보안성이 강화됩니다.
- **성능**: 브로드캐스트 트래픽이 제한됨으로써 네트워크 성능 저하를 방지할 수 있습니다.

### VLAN 액세스 포트와 구성 방법 강의 요약

1. VLAN 액세스 포트의 정의와 역할
- **액세스 포트**는 **종단 호스트**(PC, 프린터 등)가 연결된 스위치의 인터페이스로, **특정 VLAN**에 할당됩니다.
  - 예: 엔지니어링 팀의 PC가 연결된 포트를 엔지니어링 VLAN의 액세스 포트로 구성.
- **종단 호스트는 VLAN을 인식하지 않으며** 스위치에서만 VLAN 트래픽을 관리합니다.
- **VLAN**을 통해 캠퍼스 LAN을 작은 **브로드캐스트 도메인**으로 나누어 성능과 보안을 향상시킬 수 있습니다.

2. VLAN 구성의 중요성
- VLAN을 잘못 구성하면 같은 IP 서브넷에 속하는 장치들이 통신할 수 없게 됩니다.
  - 예: 영업 팀 PC를 잘못된 VLAN에 할당하면 영업 팀 VLAN 내의 다른 장치와 통신할 수 없습니다.
- **같은 IP 서브넷의 호스트는 동일한 VLAN에 속해야** 하며, 서로 다른 IP 서브넷은 각기 다른 VLAN에 속해야 합니다.

3. VLAN 구성 기본 단계
1. **VLAN 생성**
   - 글로벌 구성 모드에서 `vlan [번호]` 명령어로 VLAN을 생성.
   - VLAN에 **이름**을 지정할 수 있습니다 (`name [이름]`).

2. **스위치 포트를 VLAN에 할당**
   - 액세스 포트로 설정: `switchport mode access`
   - 특정 VLAN에 할당: `switchport access vlan [번호]`
   - 여러 포트를 한 번에 설정할 경우 `interface range` 명령어 사용: `interface range FastEthernet 0/3 - 5`

4. VLAN 구성 예제
- **엔지니어링 VLAN** (VLAN 10)
   ```plaintext
   vlan 10
   name Eng
   interface FastEthernet 0/1
   switchport mode access
   switchport access vlan 10
   interface range FastEthernet 0/3 - 5
   switchport mode access
   switchport access vlan 10
   ```
  
- **영업 VLAN** (VLAN 20)
   ```plaintext
   vlan 20
   name Sales
   interface FastEthernet 0/2
   switchport mode access
   switchport access vlan 20
   interface range FastEthernet 0/6 - 7
   switchport mode access
   switchport access vlan 20
   ```

5. VLAN 검증 명령어
- **show vlan brief**: 현재 스위치의 모든 VLAN 및 각 포트의 VLAN 할당 상태를 확인.
- **show interface [인터페이스] switchport**: 특정 포트의 VLAN 정보 확인.

이렇게 해서 **VLAN 액세스 포트를 설정**하고 **구성을 검증**하는 방법을 배웠습니다.

### VLAN 트렁크 포트

1. **액세스 포트와 VLAN 통신**
   - **액세스 포트**: 하나의 VLAN에 연결된 PC가 스위치로 통신하는 기본 포트
   - **브로드캐스트 도메인 분할**: VLAN을 통해 브로드캐스트 범위를 제한하여 성능과 보안을 향상

2. **스위치 간 VLAN 트래픽 전달 문제**
   - 여러 스위치를 사용하는 환경에서 같은 VLAN에 속한 PC가 서로 다른 스위치에 연결되면, 기본 설정만으로는 서로 통신 불가
   - **해결책**: 스위치 간 링크를 트렁크 포트로 구성하여 여러 VLAN 트래픽이 통과할 수 있도록 함

3. **트렁크 포트와 Dot1Q 트렁킹 프로토콜**
   - **Dot1Q 프로토콜**: 트래픽에 VLAN 태그를 추가하여 목적지 스위치가 VLAN을 구분 가능하게 함
   - **트렁크 포트**: 스위치 간 연결을 통해 여러 VLAN 트래픽을 전송하도록 설정한 포트

4. **트렁크 포트 구성 예시**
   - 설정 명령어:
      ```plaintext
      interface GigabitEthernet 0/1
      description Trunk to SW2
      switchport trunk encapsulation dot1q
      switchport mode trunk
      ```

5. **특수 환경의 트렁킹**
   - **가상 호스트** (VMware, HyperV): 여러 VLAN의 가상 머신 트래픽을 분리해야 하므로 트렁크 포트 필요
   - **IP 전화와 PC 연결**: 음성 트래픽과 데이터 트래픽을 분리하여 우선 처리 및 보안 확보
      ```plaintext
      interface FastEthernet 0/10
      switchport mode access
      switchport access vlan 10
      switchport voice vlan 20
      ```

6. **native VLAN과 보안**
   - **native VLAN**: 태그가 없는 트래픽이 전달될 기본 VLAN (기본값: VLAN 1)
   - **보안 권장사항**: 보안상의 이유로 VLAN 1을 피하고 사용되지 않는 VLAN으로 native VLAN을 변경
      ```plaintext
      vlan 199
      name Native
      interface GigabitEthernet 0/1
      switchport trunk native vlan 199
      ```

7. **허용 VLAN 제한**
   - **허용 VLAN 설정**: 필요한 VLAN만 트렁크 포트에서 허용하여 성능 최적화 및 보안 강화
      ```plaintext
      interface GigabitEthernet 0/1
      switchport trunk allowed vlan 10,30
      ```
8. 메모
- https://en.wikipedia.org/wiki/IEEE_802.1Q 를 보면, 어떤 식으로 구현되는지 알 수 있는데, 프레임에 표준 형식의 해더가 추가되고, 그걸 스위치에서 지원하는 식. 해당 프로토콜을 사용하는지 식별하기 위한 필드 + VLAN 식별자 + 기타 정보를 포함함.

### 동적 트렁킹 프로토콜(DTP) 개요

Cisco 스위치 간 연결 시, **동적 트렁킹 프로토콜(DTP)**를 통해 자동으로 트렁크를 설정할 수 있습니다. 그러나 보안과 안정성 측면에서 **포트를 수동으로 직접 설정**하는 것이 권장됩니다.  

포트 수동 설정 명령어:
- **액세스 포트**: `switchport mode access`
- **트렁크 포트**: `switchport mode trunk`

DTP 명령어

1. **switchport mode dynamic auto**
   - 포트가 `trunk`나 `desirable`로 설정된 인접 스위치에 연결 시 트렁크를 형성합니다.
   - 양쪽 포트가 모두 `auto`로 설정되어 있을 경우 트렁크가 형성되지 않습니다.
   - 신형 스위치의 기본 설정입니다.

2. **switchport mode dynamic desirable**
   - 인접 포트가 `trunk`, `desirable`, 또는 `auto`일 때 트렁크가 형성됩니다.
   - 구형 스위치에서는 이 설정이 기본값입니다.

3. **switchport nonegotiate**
   - DTP를 비활성화하여 자동 협상을 방지합니다. 포트를 `access`나 `trunk`로 명시적으로 설정해야 합니다.

**권장 방법**: 호스트 연결 시 `switchport mode access`, 스위치 연결 시 `switchport mode trunk` 설정을 권장합니다. (= DTP 사용하지 않고, 수동으로 설정하는 것을 권장한다는 말.)



### VTP(VLAN Trunking Protocol) 개요

**VTP**는 네트워크 내 여러 스위치에 걸쳐 **VLAN 설정을 중앙에서 관리하고 동기화**하는 Cisco 프로토콜입니다. VTP를 사용하면 **VLAN 추가, 편집, 삭제**가 VTP 서버에서 한 번 이루어지면 클라이언트 스위치들이 자동으로 동기화합니다.

- **VTP 서버**에서 VLAN을 생성하거나 삭제하면, 해당 VLAN 정보가 **VTP 클라이언트**로 구성된 스위치에 자동으로 전달됩니다.
- VTP는 **대형 네트워크**에서 일일이 VLAN을 생성할 필요 없이 중앙에서 관리할 수 있는 장점이 있습니다.
- **주의**: VTP 개정 번호가 높은 스위치가 연결되면 기존 VLAN 정보가 의도치 않게 삭제되거나 덮어씌워질 수 있으므로 VTP 사용 시 주의가 필요합니다.

메모1: 특정 스위치가 마스터가 되서 VLAN 정보를 저장하는 일종의 데이터베이스 역할을 한다고 보면 됨.
메모2: VLAN 이름이랑 id를 관리해줄 뿐, 각 스위치의 어떤 포트가 어떤 VLAN에 속하는지는 직접 설정해줘야 함.

VTP 모드 종류

1. **VTP 서버 모드**
   - VLAN을 **추가, 편집, 삭제**할 수 있으며, 클라이언트와 트랜스패런트 스위치로 VLAN 정보를 전파합니다.
   - 여러 서버를 둘 수 있지만, **가장 높은 개정 번호를 가진 서버**가 나머지 스위치를 동기화합니다.

2. **VTP 클라이언트 모드**
   - VLAN을 직접 추가하거나 삭제할 수 없고, 서버로부터 정보를 받아 동기화합니다.

3. **VTP 트랜스패런트 모드**
   - VTP 도메인에 참여하지 않으며, **VLAN 정보를 전달**만 합니다.
   - 로컬 VLAN만 관리하며, 서버 또는 클라이언트의 VLAN 변경 사항을 반영하지 않습니다.

VTP 실습 예제

1. **VTP 서버 구성**
   - 서버에서 `vtp domain Flackbox`와 `vtp mode server`로 VTP 도메인과 모드를 설정합니다.
   - 필요한 VLAN을 생성합니다. 예를 들어, `vlan 10`, `name Eng`와 `vlan 20`, `name Sales`를 입력해 VLAN Eng와 Sales를 구성합니다.

2. **VTP 클라이언트 구성**
   - 클라이언트 스위치에서 `vtp domain Flackbox`와 `vtp mode client`를 설정합니다.
   - 서버로부터 VLAN 정보를 받아 동기화합니다.

3. **VTP 트랜스패런트 구성**
   - 트랜스패런트 스위치에서 `vtp mode transparent`를 설정하고 VLAN 10과 VLAN 20을 로컬에서 수동으로 추가합니다.
   - 트랜스패런트 스위치는 VTP 도메인에 속하지 않지만, 서버와 클라이언트 사이에서 VLAN 정보를 전달합니다.

VTP 사용 시 주의사항

- VTP 도메인에 있는 모든 스위치의 **도메인 이름이 일치**해야 합니다.
- VTP 개정 번호가 더 높은 스위치가 네트워크에 추가되면, 기존 VLAN 데이터베이스가 덮어씌워질 수 있습니다.
- 실수로 과거 개정 번호가 높은 스위치를 연결해 기존 VLAN 정보가 삭제되지 않도록 **개정 번호와 설정 상태를 주의**해야 합니다.


VTP 구성 및 확인 명령어

- VTP 도메인 설정: `vtp domain <도메인 이름>`
- VTP 모드 설정: `vtp mode <server | client | transparent>`
- VLAN 생성 예시: `vlan 20`, `name Sales`

VTP 설정 확인:
- `show vtp status` 명령으로 **VTP 도메인 이름, 모드, 개정 번호** 등을 확인합니다.

