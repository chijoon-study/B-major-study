## Section 25 정리

## 네트워크 토폴로지와 스패닝 트리 및 중복 장치 구성을 통한 이중화 복습 - 3계층의 루프

### 1. **네트워크의 3계층 복습**
   - **라우팅과 경로 선택**: 3계층에서는 라우터가 경로 선택을 담당하며, 정적 경로나 동적 라우팅 프로토콜을 통해 트래픽을 최적화합니다. 
   - **HSRP (Hot Standby Router Protocol)**: 라우터 R1과 R2에 HSRP를 설정하여 장애 발생 시 자동으로 경로를 전환하게 했습니다. HSRP는 가상 IP(VIP)를 제공하여 기본 게이트웨이를 동적으로 대체합니다.

### 2. **이중화 및 장애 조치**
   - **주 경로와 백업 경로**: R1에서 SP1로 향하는 기본 경로와, SP1 장애 시 SP2를 통한 백업 경로를 설정하여 이중화했습니다. 이 경우, 관리 거리를 통해 우선순위를 설정해 더 나은 경로가 먼저 선택되도록 하였습니다.
   - **라우팅 루프 방지**: 정적 경로로 잘못 구성하면 라우팅 루프가 발생할 수 있습니다. 예를 들어, R1에서 10.10.50.0 네트워크로 가는 경로를 SP1으로 지정하고, SP1에서 SP2, SP2에서 다시 R2로 전달되는 경로를 구성할 때 루프가 생길 수 있습니다. 이를 방지하기 위해 TTL(Time To Live) 필드를 사용하여 패킷이 특정 횟수만큼 라우터를 통과하면 버려지도록 설정했습니다.
    - 패킷이 실패하면 처음 전송된 출발지에 ICMP 시간 초과 메시지를 보낸다.

### 3. **2계층 스위치 네트워크에서의 루프 방지**
   - **스패닝 트리 프로토콜(STP)**: 2계층에서는 라우팅이 아닌 스패닝 트리를 통해 네트워크 루프를 방지합니다. STP는 2계층에서 루프 방지와 경로 선택을 자동화하여 네트워크 안정성을 유지합니다.

이번 강의는 3계층 라우팅과 중복성 설정에 대한 기초와, 의도치 않게 발생할 수 있는 라우팅 루프를 방지하는 TTL 필드의 역할에 대해 자세히 설명하였습니다.

## 스패닝 트리 프로토콜(STP)의 존재 이유

이번 강의는 **스패닝 트리 프로토콜**(STP)의 필요성을 이해하는 데 집중합니다.

1. **이더넷 경로 설정 개념**
   - 네트워크에서 각 스위치가 MAC 주소 테이블을 통해 경로를 설정합니다.
   - 예시로 PC1이 R1의 IP 주소(10.10.10.2)로 트래픽을 보내려는 상황을 사용합니다.
   - PC1이 R1과 통신 기록이 없을 경우, **ARP 요청**을 통해 네트워크 전체에 브로드캐스트 트래픽을 발생시킵니다.

2. **스패닝 트리 프로토콜의 필요성**
   - **브로드캐스트 트래픽의 무한 루프** 문제: 스패닝 트리가 없으면 브로드캐스트 트래픽이 계속 순환하며 루프가 발생하게 됩니다.
   - 이때, 스위치들이 계속해서 트래픽을 재전송하여 **브로드캐스트 스톰**이 발생하고 네트워크가 과부하되어 작동이 멈출 수 있습니다.
   - 제2계층 네트워크의 이더넷 헤더에는 **TTL(Time to Live)** 값이 없어, 루프가 멈추지 않고 계속됩니다.

3. **스패닝 트리의 역할**
   - STP는 **루프 방지**를 위해 스위치 포트를 차단하여, 물리적 경로가 연결되어 있어도 논리적으로 네트워크 루프를 차단합니다.
   - 이를 통해 브로드캐스트 스톰을 방지하고 네트워크를 안정적으로 유지합니다.
   - 예시에서, STP는 CD1과 CD2 사이, Acc3와 Acc4 사이의 루프를 방지하기 위해 특정 포트를 비활성화했습니다. 이를 통해, 필요할 때는 포트를 활성화하여 장애 발생 시 대체 경로를 제공합니다.

4. **스패닝 트리의 한계**
   - **대역폭 제한**: 일부 포트를 비활성화함으로써 이용 가능한 물리적 대역폭을 줄이게 됩니다.
   - **느린 수렴 시간**: 장애 감지 후 복구가 이루어질 때 최대 50초가 소요될 수 있습니다.
   - STP의 단점은 물리적으로 연결된 인터페이스를 비활성화하여 대역폭을 감소시킨다는 점과 수렴 속도가 느리다는 것입니다. STP가 네트워크의 모든 경로를 확인하고 안정적인 상태로 수렴하는 데 최대 50초까지 소요될 수 있습니다.

5. **스패닝 트리와 장애 조치**
   - STP는 자동으로 장애를 감지하고 차단된 포트를 활성화해 대체 경로를 제공합니다.

이로써 STP는 이더넷 네트워크에서 발생할 수 있는 루프를 방지하는 데 필수적임을 알 수 있습니다.

## 허브, 브리지, 스위치

#### 1. 허브 (Legacy)
- **정의**: 제1계층 장치로 가장 기본적인 네트워크 연결 장비
- **특징**:
  - MAC 주소 학습 불가
  - 모든 트래픽을 모든 포트로 전송 (송신 포트 제외)
  - 브로드캐스트/유니캐스트/멀티캐스트 트래픽 모두 전체 전송
  - 현재는 완전히 단종됨

#### 2. 브리지 (Bridge)
- **정의**: 제2계층 장치로 허브와 스위치의 중간 단계
- **주요 특징**:
  - 2개의 포트 구성
  - MAC 주소 학습 가능
  - 충돌 도메인 분할 기능
- **역할**:
  - 대형 충돌 도메인을 2개의 작은 도메인으로 분할
  - 필요한 트래픽만 선별적으로 전달

#### 3. 스위치 (현재 표준)
- **정의**: 브리지의 현대화 버전
- **특징**:
  - 다중 포트 지원
  - 향상된 성능과 보안
  - 스마트한 트래픽 관리

#### 용어 사용의 실제
- **스패닝 트리 관련**: 브리지 시대의 용어 계승
  - 루트 브리지
  - BPDU (Bridge Protocol Data Unit)
- **현대적 사용**:
  - 일반적 상황: '스위치' 사용
  - 기술 문서/프로토콜: '브리지' 용어 잔존 - 스패닝 트리 프로토콜을 학습할 때 '브리지'라는 용어가 자주 등장함.

## 스패닝 트리 작동 방식 요약

#### 1. **스패닝 트리 개요**
   - **스패닝 트리 프로토콜 (STP)**: 모든 벤더의 스위치에 기본적으로 활성화된 네트워크 루프 방지 표준.
   - **목적**: 브로드캐스트 폭풍과 같은 네트워크 루프 문제를 방지함으로써 안정적인 LAN 환경을 유지.

#### 2. **BPDU의 역할**
   - **BPDU (Bridge Protocol Data Unit)**: 스위치가 루프를 감지하고 트래픽을 전달할 준비가 될 때까지 사용.
   - **과정**: 스위치가 루프가 없는지를 확인하는 동안 트래픽은 차단 상태가 되며, 루프가 없다고 확정되면 전달 상태로 전환.

#### 3. **루트 브리지 선출**
   - **루트 브리지**: 네트워크 상에서 트래픽 경로를 결정하는 기준이 되는 스위치.
   - **선출 기준**:
     - **브리지 우선순위 값** (기본값 32768, 낮을수록 우선).
     - 우선순위가 같다면 **MAC 주소**가 낮은 스위치가 선택.

#### 4. **스패닝 트리 경로 비용 계산**
   - **비용 계산**: 스위치가 루트 브리지까지의 경로 중 가장 낮은 비용 경로를 선택.
   - **인터페이스 대역폭 선호**: 더 높은 대역폭의 인터페이스가 비용이 낮음. 예: 기가비트 이더넷(비용 4) > 고속 이더넷(비용 19).
   - **숏 모드 vs 롱 모드**:
     - **숏 모드**: 원래 방식으로 20Gbps까지 지원.
     - **롱 모드**: 더 세분화된 32비트 값으로 최신 고속 네트워크 지원.

#### 5. **루트 포트와 지정 포트**
   - **루트 포트**: 각 스위치가 루트 브리지로 도달하기 위한 최저 비용 경로에 해당하는 포트.
   - **지정 포트**: 루트 포트와 반대편에 위치하며 네트워크 트래픽을 전달하는 경로 역할을 함.
   - 루트 브리지에서 멀어지는 모든 포트는 **지정 포트**가 된다.

#### 6. **트래픽 경로 설정과 루프 방지**
   - **최적 경로**: 스위치가 루트 브리지로의 최적 경로를 계산하고, 해당 경로로 트래픽을 전달.
   - **루프 방지**: 잠재적인 루프 경로는 스패닝 트리에 의해 차단되어, 네트워크가 안정적으로 유지됨.

#### 7. **장애 조치(Failover)와 비용 조정**
   - 스패닝 트리가 링크 장애를 감지하면 다른 경로로 장애 조치하여 네트워크 연속성 유지.
   - **비용 조정**: 인터페이스 비용을 조정하여 경로를 변경 가능.

### 좀 더 구체적인 버전

### 스패닝 트리 프로토콜(STP)의 작동 원리: 스위치 네트워크의 안정성을 위한 핵심 기법

이번 강의에서는 네트워크 상의 루프를 방지하기 위한 **스패닝 트리 프로토콜(STP)**의 작동 방식에 대해 자세히 살펴보겠습니다. STP는 여러 스위치가 상호 연결된 복잡한 네트워크 환경에서 루프를 방지하고, 네트워크의 안정성을 유지하기 위해 모든 스위치에서 기본적으로 활성화되어 있는 산업 표준 프로토콜입니다.

#### 1. 스패닝 트리 프로토콜(STP)의 중요성

로컬 영역 네트워크(LAN)에서 루프가 발생하게 되면, 데이터 패킷이 끝없이 순환하게 되어 **브로드캐스트 폭풍**이라는 심각한 문제를 야기할 수 있습니다. 브로드캐스트 폭풍은 네트워크의 가용성을 저하시킬 뿐만 아니라, 모든 장비에 부담을 주어 전체 네트워크의 성능을 저하시키게 됩니다. **STP**는 이러한 루프를 방지하고 네트워크 상의 안정성을 보장하기 위해 사용됩니다. 

#### 2. BPDU(Bridge Protocol Data Unit)와 스위치 네트워크 구성

스위치가 온라인 상태로 전환되면 **BPDU**라는 메시지를 전송하여 인접 스위치와의 상호 연결 상태를 확인하고, 잠재적인 루프를 감지합니다. 스위치의 각 포트는 루프가 발생할 가능성이 없다는 것이 확실해질 때까지 트래픽을 전달하지 않으며, 초기에는 차단 상태에 있게 됩니다. 스위치 간에 BPDU 메시지를 통해 상호 간의 브리지 ID를 공유하게 되며, 브리지 ID는 해당 스위치를 식별하는 고유한 값입니다.

#### 3. 브리지 ID(Bridge ID)와 루트 브리지 선정

BPDU에는 스위치의 **브리지 ID**가 포함되며, 이는 스위치의 고유 MAC 주소와 관리자가 정의한 **브리지 우선순위** 값으로 구성됩니다. 브리지 우선순위는 0에서 65535 사이의 값을 가지며, 기본값은 32768입니다. STP는 네트워크에서 가장 낮은 브리지 ID 값을 가진 스위치를 **루트 브리지**로 선정합니다. 브리지 우선순위가 같을 경우에는 MAC 주소가 가장 낮은 스위치가 루트 브리지로 선택됩니다. 루트 브리지는 네트워크의 중심 역할을 하며, 모든 스위치들은 루트 브리지에 도달하기 위한 최적의 경로를 계산하고 해당 경로를 통해 트래픽을 전달하게 됩니다.

#### 4. 루트 브리지에 도달하는 경로 결정

각 스위치는 루트 브리지로의 최적 경로를 계산하기 위해 링크의 대역폭을 고려하여 비용을 산정합니다. STP에서는 **링크의 대역폭이 높을수록 비용이 낮아지며**, 스위치는 비용이 가장 낮은 경로를 선택하여 루트 브리지로의 최적 경로를 설정하게 됩니다. 네트워크 상의 모든 스위치들은 루트 브리지에 도달하기 위한 루트 포트를 설정하고, 가장 적절한 경로만 트래픽을 전달하게 되므로 루프가 방지됩니다.

#### 5. 스패닝 트리 모드의 종류: Short Mode와 Long Mode

STP는 **Short Mode**와 **Long Mode**라는 두 가지 모드를 가지고 있으며, 기본적으로 **Short Mode**가 활성화되어 있습니다. **Short Mode**에서는 1기가비트 이상의 인터페이스에 대해 고정 비용을 할당하여 속도 차이에 따른 추가적인 분류가 어렵습니다. 그러나 현대 네트워크에서는 1기가비트 이상의 대역폭을 가진 링크가 일반적이므로, **Long Mode**를 사용하여 더 높은 대역폭을 가진 링크를 선호하게 설정할 수 있습니다.

#### 6. STP의 작업 절차: 루트 브리지 선정과 트래픽 경로 최적화

스위치들이 서로 연결되면, 스위치들은 **BPDU**를 주고받으며 자신들의 **브리지 ID**를 광고합니다. STP는 다음과 같은 단계로 작동합니다:

1. **루트 브리지 선출**: BPDU 메시지를 통해 각 스위치는 가장 낮은 브리지 ID를 가진 스위치를 **루트 브리지**로 선정하게 됩니다.
2. **루트 포트 설정**: 각 스위치는 루트 브리지에 도달하기 위한 최적 경로를 찾아 **루트 포트**로 설정하고, 그 경로를 통해 트래픽을 전달합니다.
3. **지정 포트 설정**: 각 링크의 반대쪽 포트는 지정 포트로 설정됩니다. 루트 포트는 루트 브리지로의 최적 경로를 의미하고, 지정 포트는 해당 링크를 통해 트래픽이 전달될 수 있는지를 나타냅니다.
   
STP가 모든 루프를 방지할 수 있도록 설정이 완료되면 네트워크에서 루프가 형성될 가능성이 있는 포트들은 차단 상태로 전환됩니다. 예를 들어, 네트워크 상에서 두 개의 스위치가 루트 브리지로 가기 위한 동일한 비용의 경로를 가지고 있다면, STP는 가장 낮은 브리지 ID를 가진 스위치와 연결된 경로를 통해 트래픽을 전송하도록 선택하고, 나머지 경로는 차단하게 됩니다.

#### 7. 링크 실패 시의 장애 조치

STP는 장애 조치 기능도 제공합니다. 만약 루트 브리지로의 주요 경로가 실패할 경우, STP는 차단된 예비 경로를 활성화하여 트래픽을 우회시킵니다. 예를 들어, 루트 브리지와의 연결이 단절되면 스위치들은 자동으로 예비 경로를 탐지하고, 그 경로를 통해 트래픽을 전송하게 됩니다.

#### 8. 경로 조작: 인터페이스 비용 변경

관리자는 각 링크의 비용을 수동으로 변경하여 트래픽 경로를 조정할 수 있지만, 이 경우 모든 스위치에 동일한 설정을 적용해야 네트워크 혼란을 방지할 수 있습니다. 예를 들어, 특정 링크의 비용을 낮게 설정하면 스위치는 해당 경로를 선호하게 되고, 트래픽이 그 경로로 유입되게 됩니다.

#### 9. STP와 부하 분산의 제한

스패닝 트리 프로토콜은 **동일 비용 부하 분산**을 지원하지 않습니다. 이는 STP가 네트워크 상의 단일 경로를 통해서만 트래픽을 전달하도록 설계되었기 때문입니다. 네트워크 상의 모든 스위치는 루트 브리지로의 최적 경로만 선택하게 되며, 동일한 비용을 가진 다수의 경로가 존재하더라도 하나의 경로만 활성화됩니다. 이로 인해 네트워크 상에서 다중 경로를 활용한 부하 분산에는 한계가 있습니다.

#### 10. 결론: 스패닝 트리 프로토콜의 역할과 한계

스패닝 트리 프로토콜(STP)은 네트워크 상의 루프를 방지하고, 스위치 네트워크의 안정성을 유지하기 위한 필수적인 프로토콜입니다. STP는 루트 브리지를 중심으로 모든 스위치가 최적 경로를 통해 트래픽을 전달하게 하며, 링크 실패 시에 자동으로 대체 경로를 설정하여 네트워크의 연속성을 보장합니다. 그러나 STP는 다중 경로 부하 분산을 지원하지 않기 때문에, 고도화된 네트워크 환경에서는 스패닝 트리와 함께 다중 경로 프로토콜(Multipath Protocol)과 같은 부하 분산 기능을 갖춘 네트워크 프로토콜을 결합하여 사용해야 할 필요가 있습니다.

---

#### 포트의 종류

맞습니다. 스패닝 트리 프로토콜(STP)에서는 포트의 종류가 **3가지**로 구분됩니다. 각 포트는 스패닝 트리의 작동 과정에서 중요한 역할을 담당하며, 아래와 같은 세 가지 종류로 나뉩니다.

1. **루트 포트 (Root Port)**  
   - 각 스위치에서 **루트 브리지로 가는 최단 경로**를 담당하는 포트입니다.
   - 루트 포트는 모든 스위치에 하나씩만 존재하며, 루트 브리지에서는 루트 포트가 없습니다. 
   - 루트 포트는 루트 브리지에 연결되는 경로 중 비용이 가장 낮은 경로를 따라 트래픽을 전달합니다.

2. **지정 포트 (Designated Port)**  
   - 네트워크 세그먼트에서 루트 브리지로의 트래픽을 전송할 **대표 포트**입니다.
   - 지정 포트는 특정 네트워크 세그먼트에서 루트 브리지로 가는 가장 비용이 낮은 경로를 책임지며, 여러 스위치가 같은 네트워크 세그먼트에 연결된 경우 **하나의 지정 포트만 활성화**됩니다.
   - 루트 포트와 반대로 지정 포트는 네트워크 세그먼트마다 하나씩 존재합니다.

3. **차단 포트 (Blocking Port)**  
   - 루프를 방지하기 위해 트래픽을 전송하지 않도록 **차단된 상태**로 유지되는 포트입니다.
   - 차단 포트는 루프를 방지하고 네트워크 안정성을 확보하기 위해 지정되며, 활성화된 루트 포트와 지정 포트 이외의 모든 포트가 차단 포트가 됩니다.
   - 차단 포트는 BPDU 메시지만 수신하고 데이터 트래픽을 전송하지 않습니다.

#### 추가 설명: 포트 상태와 장애 복구

각 포트는 STP의 동작 상태에 따라 **포트 상태**가 변할 수 있습니다. 예를 들어, 링크에 문제가 생기면 차단된 포트가 루트 포트나 지정 포트로 전환될 수 있습니다. 이 경우 네트워크는 자동으로 장애 복구가 이루어져 데이터 전송이 재개됩니다.


## 1. 스패닝 트리 프로토콜(STP) 표준

이번 강의는 스패닝 트리의 다양한 버전에 대해 설명하며, 개방형 표준과 Cisco 독점 버전을 비교하고 각 버전의 특징과 차이점을 소개합니다. 

스패닝 트리의 최초 구현은 **IEEE 802.1D**로, 이는 하나의 스패닝 트리 인스턴스를 사용하여 LAN의 모든 VLAN을 관리합니다. 그러나 802.1D는 최대 50초의 느린 수렴 시간을 가져 네트워크 루프 방지에 시간이 오래 걸리는 단점이 있습니다. 이를 해결한 개선 버전인 **IEEE 802.1w**는 **Rapid Spanning Tree Protocol (RSTP)**로, 수렴 시간을 크게 단축시켜 보통 몇 초 만에 네트워크 구성을 완료합니다. 하지만 RSTP 역시 모든 VLAN에 대해 하나의 스패닝 트리 인스턴스만을 사용하여 부하 분산에는 한계가 있습니다. 

산업 표준의 최신 버전인 **IEEE 802.1s**, 즉 **Multiple Spanning Tree Protocol (MSTP)**은 VLAN을 그룹화하여 여러 스패닝 트리 인스턴스로 분리할 수 있습니다. 이를 통해 VLAN을 네트워크에서 다른 경로로 분산하여 부하 분산을 지원할 수 있습니다. 
- 즉, VLAN별로 다른 루트 브릿지를 설정할 수 있음. 이후에 HSRP를 사용하여 VLAN 부하 분산 + 백업 루트 브릿지를 설정할 때 사용됨.
  - 백업 자체는 그룹이 없어도 상관 없는데, VLAN 그룹 단위로 부하분산을 하는데 유용함.

### 2. Cisco 독점 버전

Cisco는 독점적으로 **Per VLAN Spanning Tree Plus (PVST+)**와 **Rapid PVST+**를 제공합니다. PVST+는 802.1D와 유사하지만 각 VLAN에 대해 별도의 스패닝 트리 인스턴스를 만들어 부하 분산을 가능하게 합니다. 그러나 802.1D와 마찬가지로 느린 수렴 시간의 한계가 있습니다. 이를 개선한 Rapid PVST+는 **802.1w**의 RSTP와 유사하며, 빠른 수렴 시간을 지원합니다. 

Cisco의 PVST+와 Rapid PVST+는 MSTP와의 주요 차이점이 각 VLAN마다 독립적인 스패닝 트리 인스턴스를 사용하는 점입니다. MSTP에서는 여러 VLAN을 하나의 그룹으로 묶을 수 있어 스위치에 가해지는 부하를 줄일 수 있는 반면, Cisco의 PVST+ 및 Rapid PVST+에서는 VLAN 단위로 별도의 인스턴스를 계산하기 때문에 스위치에 더 많은 부하를 가하게 됩니다.

### 3. 부하 분산 예시

부하 분산의 예를 들어 보면, 액세스 계층 스위치가 두 개의 코어 분배 스위치(CD1, CD2)에 연결된 상황에서 VLAN을 활용해 트래픽을 분산합니다. 예를 들어 CD1을 VLAN 10~19의 루트 브리지로 설정하고, CD2를 VLAN 20~29의 루트 브리지로 설정하여 트래픽이 각 루트 브리지로 향하는 경로를 다르게 설정합니다. MSTP나 PVST+를 통해 장애 발생 시 트래픽이 자동으로 다른 링크로 페일오버되어 안정성을 보장합니다.

### 4. 스패닝 트리 버전 선택과 명령어

스패닝 트리 버전은 네트워크의 특정 요구 사항과 스위치의 모델에 따라 선택할 수 있습니다. **`spanning-tree mode`** 명령어로 스위치에서 사용할 스패닝 트리 모드를 선택할 수 있으며, 일반적으로 Cisco 스위치는 PVST+와 Rapid PVST+, MST를 지원합니다. 실행 중인 스패닝 트리 모드를 확인하기 위해 **`show spanning-tree summary`** 명령어를 사용하며, PVST+에서 Rapid PVST+로 전환할 때 기존 구성을 유지하고 빠른 수렴 속도의 이점을 누릴 수 있습니다.

### 5. 주의 사항: 스패닝 트리 용어와 버전 구분

스패닝 트리 용어 중에서 **차단 포트**는 Cisco에서는 **대체 포트**로 표기되며, 이는 현재는 차단 상태이지만, 장애 발생 시 활성화될 수 있는 포트를 의미합니다. 

강의에서는 표준 버전별 명확한 구분을 위해 용어의 혼동을 피하도록 강조합니다.

## 스패닝 트리 프로토콜(STP) 검증 명령어 정리

#### 1. 기본 검증 명령어
```
show spanning-tree vlan [VLAN번호]
```
- VLAN을 지정하지 않으면 모든 VLAN의 스패닝 트리 정보 표시
- 많은 VLAN이 있을 경우 출력이 길어지므로 특정 VLAN 지정 권장

#### 2. 명령어 출력 구조

(생략함)

#### 3. 포트 상태 확인
- **포워딩(Forwarding)**: 트래픽 전송 가능
- **차단(Blocking)**: 루프 방지를 위해 비활성화
- **지정(Designated)**: 세그먼트에 대한 지정 포트
- **루트(Root)**: 루트 브리지로 가는 최적 경로 포트

#### 4. 비용 계산
- FastEthernet 링크 비용: 19
- 총 경로 비용 = 경로상의 모든 링크 비용의 합
- 예시: 
  ```
  스위치A → FastEthernet → 스위치B → FastEthernet → 루트
  총 비용 = 19 + 19 = 38
  ```

#### 5. 실제 사용 팁
- 스패닝 트리 토폴로지 파악을 위해서는 각 스위치별로 명령어 실행 필요
- 토폴로지 매핑을 위해 연필과 종이 사용 권장
- 루트 브리지 확인 후 각 스위치의 포트 상태 순차적 확인


# MAC 주소 테이블을 이용한 트래픽 경로 검증

#### 1. 기본 명령어
```cisco
# MAC 주소 테이블 확인
show mac address-table

# 인터페이스 정보 확인 (MAC 주소 포함)
show interface [interface-id]
```

#### 2. 트래픽 경로 검증 절차

1. 목적지 장치의 MAC 주소 확인
```cisco
show interface gigabitethernet 0/1
```

2. ARP 캐시 초기화 및 트래픽 생성
```cisco
clear arp-cache
ping [destination-ip]
```

3. 각 스위치에서 MAC 주소 테이블 확인
```cisco
show mac address-table | include [MAC주소]
```

#### 3. 검증 단계별 확인사항

1. **출발지 스위치**
   - MAC 주소가 학습된 출력 포트 확인
   - 예상 경로와 일치 여부 검증

2. **중간 스위치들**
   - 각 스위치에서 MAC 주소 테이블 확인
   - 트래픽 전달 포트 확인

3. **최종 목적지 스위치**
   - 목적지 장치로 연결된 포트 확인

#### 4. 트래픽 경로 분석 시 주의사항
- 최단 경로가 아닐 수 있음
- STP(스패닝 트리 프로토콜) 구성에 따라 경로가 결정됨
- 실제 네트워크에서는 최적화된 경로 설정 필요

#### 5. 문제 해결 팁
- MAC 주소 테이블이 비어있다면 트래픽 생성 필요
- 각 홉(hop)별로 순차적 확인
- 예상 경로와 실제 경로 비교 분석

## 스패닝 트리 루트 브리지 문제와 해결방안

#### 1. 문제 상황
- **기본 설정의 위험성**
  - 모든 스위치가 기본 우선순위(32768) 사용
  - MAC 주소가 가장 낮은 스위치가 루트 브리지가 됨
  - 주로 가장 오래된 스위치가 선택됨

- **문제점**
  - 오래된 스위치: CPU/메모리 제한적
  - 낮은 대역폭 링크 사용
  - 비효율적인 트래픽 경로
  - 과도한 홉 수로 인한 지연 발생

#### 2. 해결방안
##### 기본 전략
- 코어 스위치를 루트 브리지로 설정
- 백업 코어 스위치를 보조 루트로 설정

##### 구성 방법
1. **주 루트 브리지 설정**
   ```cisco
   spanning-tree vlan 1 root primary
   ```
   - 우선순위: 24576
   - 중앙 집중화된 경로 확보
   - 홉 수 감소

2. **보조 루트 브리지 설정**
   ```cisco
   spanning-tree vlan 1 root secondary
   ```
   - 우선순위: 28672
   - 주 루트 실패 시 백업 역할
   - 중앙 집중화된 경로 유지

#### 3. 기대 효과
- 트래픽 경로 최적화
- 네트워크 성능 향상
- 안정적인 백업 경로 확보
- 코어 스위치의 고성능 활용


## HSRP와 스패닝 트리 정렬 구성 가이드

#### 1. 목적
- 트래픽 경로 최적화
- 불필요한 홉 제거
- HSRP와 STP 경로 일치
- 효율적인 부하 분산

#### 2. 기본 구성 전략
##### VLAN 10 구성
```cisco
# R1 설정 (주 게이트웨이)
interface g0/1.10
 encap dot1q 10
 ip address 10.10.10.2 255.255.255.0
 standby 1 ip 10.10.10.1
 standby 1 priority 110
 standby 1 preempt

# CD1 설정 (주 스위치)
spanning-tree vlan 10 root primary
```

##### VLAN 20 구성
```cisco
# R2 설정 (주 게이트웨이)
interface g0/1.20
 ip address 10.10.20.3 255.255.255.0
 standby 1 ip 10.10.20.1
 standby 1 priority 110
 standby 1 preempt

# CD2 설정 (주 스위치)
spanning-tree vlan 20 root primary
```

#### 3. 부하 분산 효과
- VLAN 10 트래픽: PC → CD1 → R1
- VLAN 20 트래픽: PC → CD2 → R2
- 트래픽이 두 경로로 균등하게 분산

#### 4. 장애 대비
##### VLAN 10
- CD1 장애 시: CD2가 root secondary로 대체
- R1 장애 시: R2가 HSRP standby로 대체

##### VLAN 20
- CD2 장애 시: CD1이 root secondary로 대체
- R2 장애 시: R1이 HSRP standby로 대체

#### 5. 이점
- 최적화된 트래픽 경로
- 자동 페일오버 지원
- 효율적인 네트워크 리소스 활용
- 단일 장애 지점 제거

## 스패닝 트리와 관련된 네트워크 보호 기능

이 강의에서는 **스패닝 트리와 관련된 네트워크 보호 기능**들에 대해 설명합니다. 주요 기능으로는 **포트패스트(PortFast)**, **BPDU 가드** 및 **루트 가드**가 있으며, 이들은 네트워크 루프와 의도치 않은 루트 브리지 설정을 방지하여 네트워크 안정성을 유지하는 데 중요한 역할을 합니다.

### 1. 포트패스트 (PortFast)
- **문제**: 스위치 포트가 활성화될 때 스패닝 트리 프로토콜은 기본적으로 루프 방지를 위해 30초 동안 포트를 지연 상태로 둡니다. 하지만, PC 등 단일 연결을 갖는 엔드 장치는 루프를 형성할 가능성이 없기 때문에 이 지연이 불필요할 수 있습니다.
- **해결방법**: **포트패스트**를 활성화하면 엔드 호스트에 연결된 포트는 즉시 포워딩 상태로 전환되어, 장치가 빠르게 네트워크에 접속할 수 있게 됩니다.
- **설정 방법**: `spanning-tree portfast` 명령어를 사용하여 설정하며, 트렁크 포트가 아닌 액세스 포트에서만 사용해야 합니다. 특수한 경우에 트렁크 포트에서 포트패스트가 필요한 경우 `spanning-tree portfast trunk` 명령어를 사용하여 설정할 수 있습니다.
- 포트패스트 엣지: 포트패스트 엣지는 포트패스트의 기본 기능을 확장하여, 포트가 활성화된 후 즉시 포워딩 상태로 전환하도록 보장하는 동시에 보다 강력한 보안을 제공합니다. 스위치가 아닌 장비가 연결될 경우 해당 포트를 자동으로 비활성화하여 루프를 방지하는 추가적인 보안 기능을 제공하며, 이는 **"엣지 포트"**에서 주로 사용.


### 2. BPDU 가드 (BPDU Guard)
- **문제**: 포트패스트가 설정된 포트에 사용자가 스위치를 잘못 연결하면, 해당 포트에서 루프가 형성될 수 있으며, 이는 브로드캐스트 폭풍을 일으켜 네트워크 장애를 유발할 수 있습니다.
  - Host가 연결될 것이라 가정한 포트에서 스위치가 연결되고, 그게 다른 스위치랑 연결되면 루프가 발생할 수 있음. 따라서 포트패스트에서 BPDU가 오면 해당 포트를 비활성화
- **해결방법**: 포트패스트 포트에서 **BPDU 가드**를 활성화하면, BPDU (Bridge Protocol Data Unit)를 수신하는 순간 포트가 오류 비활성화 상태로 전환되어, 즉시 포트를 셧다운하고 루프를 방지합니다.
- **설정 방법**: 포트에 `spanning-tree bpduguard enable` 명령어를 추가하여 BPDU 가드를 활성화합니다. 자동 오류 복구 기능을 설정하지 않는 것이 좋습니다.

### 3. 루트 가드 (Root Guard)
- **문제**: 잘못된 스위치가 루트 브리지로 설정될 경우, 네트워크 트래픽 흐름이 의도치 않게 변경될 수 있습니다. 이는 구형 스위치를 새 네트워크에 연결하거나 공격자가 의도적으로 루트 브리지 변경을 시도할 때 발생할 수 있습니다.
- **해결방법**: **루트 가드**를 활성화하면, 루트 가드가 설정된 포트에서 더 우수한 BPDU를 수신할 경우, 해당 포트를 root-inconsistent 상태로 전환하여 트래픽이 전달되지 않도록 막습니다.
- **설정 방법**: `spanning-tree guard root` 명령어를 사용하여 특정 포트에 루트 가드를 설정합니다.

## BPDU 필터 vs BPDU 가드

- BPDU 가드: BPDU 수신 시 포트를 오류 비활성화
  - 권장 구성: 엔드호스트 포트에 포트패스트 + BPDU 가드
- BPDU 필터: BPDU를 필터링하지만 포트는 활성 상태 유지 
  - 일반적으로 사용 비권장 - 추가 연결 시 루프 발생 가능성 있음.
  - 예외적 사용: 구형 스위치와의 단일 하향 연결 시

## 루프 가드(Loop Guard) 정리

#### 1. 목적
- 단방향 링크 장애 방지
- 스패닝 트리 루프 방지
- 주로 광섬유 연결에서 발생하는 문제 해결

#### 2. 작동 방식
- 루트/차단 포트에서 BPDU 미수신 시 포트를 루프 불일치 상태로 전환
- BPDU 수신 재개 시 자동 복구
- 지정 포트에서는 작동하지 않음

#### 3. 설정 명령어
```cisco
# 전역 설정
Switch(config)# spanning-tree loopguard default

# 인터페이스별 설정
Switch(config-if)# spanning-tree guard loop
```

#### 4. 확인 명령어
```cisco
# 전체 상태 확인
show spanning-tree summary

# 특정 인터페이스 확인
show spanning-tree interface [interface-name] detail
```

#### 5. 주요 특징
- PVST+, RPVST+, MST 모두 지원
- 루트 가드와 동시 사용 불가
- 자동 복구 지원
- 단방향 링크 문제 예방

#### 6. 적용 지침
- 코어/디스트리뷰션 스위치 간 연결에 권장
- 엔드 호스트 연결 포트에는 불필요
- 루트 가드와 함께 사용 시 인터페이스 레벨에서 구성

## 191. CCNA v1.1: PVST+ versus RPVST+ Convergence - 생략 - 강의도 넘김.
## 192. CCNA v1.1: RPVST+ and Hub Interoperability - 생략 - 강의도 넘김.

# 요약 겸 리뷰

- STP: 2계층의 루프 방지 목적
  - 루트 브리지를 정하고, 루트 브리지를 기준으로 경로를 계산하고 네트워크 내 트리 구조를 생성.
    - 트리 구조에서 유추 가능하듯, 루프가 발생할 수 없음.
      - 이거랑 관련해서 생각난게, DFS, BFS에서는 접근한 노드를 기록해야 하지만, 트리는 구조 특성 상 그런거 없어도 알고리즘 문제 푸는데 지장 없었음.
    - 이 과정에서 스위치들은 BPDU를 주고 받음.
    - 연결된 인터페이스더라도, 루프 발생 가능성 때문에 Blocked인 경우 통신에 사용되지 않음.
    - 스위치가 차단되면 BPDU를 주고받아서 다시 경로를 설정함. (= 트리 구조가 깨짐. 트리 구조가 되도록 수정)
  - 최신 STP 프로토콜은 VLAN 그룹화가 가능해서 부하분산 + HSRP를 사용하여 SPOF 방지가 가능.
  - PortFast, BPDU Guard, Root Guard 등의 네트워크 보호 기능을 지원함.

